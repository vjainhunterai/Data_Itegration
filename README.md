SELECT `C3`, `C5`, `INVOICE_NUMBER`, `INVC_ITEM_DESCRIPTION`, `INVC_START_DT`, `C1` FROM (SELECT `C3`, `C5`, `INVOICE_NUMBER`, `INVC_ITEM_DESCRIPTION`, `INVC_START_DT`, sum(`INVC_LINE_VALUE`) AS `C1` FROM (SELECT `OTBL`.`INVC_LINE_VALUE`, `OTBL`.`INVOICE_NUMBER`, `OTBL`.`INVC_ITEM_DESCRIPTION`, `OTBL`.`INVC_START_DT`, `OTBL`.`C3`, `OTBL`.`C5` FROM (SELECT `OTBL`.`PARTY_GROUP_KEY`, `OTBL`.`INVC_LINE_VALUE`, `OTBL`.`INVOICE_NUMBER`, `OTBL`.`INVC_ITEM_DESCRIPTION`, `OTBL`.`INVC_START_DT`, `OTBL`.`VENDOR_KEY`, `OTBL`.`VENDOR_GROUP_KEY`, `OTBL`.`PRD_KEY`, `OTBL`.`INVC_SLU_PROD`, `OTBL`.`MNTH_KEY`, `OTBL`.`PARTY_RO_KEY`, `OTBL`.`INVC_LINE_QUANTITY`, `OTBL`.`vendor_spend_key`, `OTBL`.`OEM_KEY`, `OTBL`.`C1`, `OTBL`.`PARTY_GROUP_CODE`, `OTBL`.`PARTY_GROUP_NAME`, `OTBL`.`PARTY_GROUP_NAME_ALIAS`, `OTBL`.`EFF_START_DT`, `OTBL`.`EFF_END_DT`, `OTBL`.`CRN_ROW_IND`, `OTBL`.`party_name_hash`, `OTBL`.`C2`, `OTBL`.`C3`, `OTBL`.`C4`, `OTBL`.`C5`, `OTBL`.`C6`, `ITBL`.`mnth_key` AS `C7`, `ITBL`.`C2` AS `C8` FROM (SELECT `OTBL`.`PARTY_GROUP_KEY`, `OTBL`.`INVC_LINE_VALUE`, `OTBL`.`INVOICE_NUMBER`, `OTBL`.`INVC_ITEM_DESCRIPTION`, `OTBL`.`INVC_START_DT`, `OTBL`.`VENDOR_KEY`, `OTBL`.`VENDOR_GROUP_KEY`, `OTBL`.`PRD_KEY`, `OTBL`.`INVC_SLU_PROD`, `OTBL`.`MNTH_KEY`, `OTBL`.`PARTY_RO_KEY`, `OTBL`.`INVC_LINE_QUANTITY`, `OTBL`.`vendor_spend_key`, `OTBL`.`OEM_KEY`, `OTBL`.`C1`, `OTBL`.`PARTY_GROUP_CODE`, `OTBL`.`PARTY_GROUP_NAME`, `OTBL`.`PARTY_GROUP_NAME_ALIAS`, `OTBL`.`EFF_START_DT`, `OTBL`.`EFF_END_DT`, `OTBL`.`CRN_ROW_IND`, `OTBL`.`party_name_hash`, `OTBL`.`C2`, `OTBL`.`C3`, `OTBL`.`C4`, `ITBL`.`C1` AS `C5`, `ITBL`.`prd_key` AS `C6` FROM (SELECT `OTBL`.`PARTY_GROUP_KEY`, `OTBL`.`INVC_LINE_VALUE`, `OTBL`.`INVOICE_NUMBER`, `OTBL`.`INVC_ITEM_DESCRIPTION`, `OTBL`.`INVC_START_DT`, `OTBL`.`VENDOR_KEY`, `OTBL`.`VENDOR_GROUP_KEY`, `OTBL`.`PRD_KEY`, `OTBL`.`INVC_SLU_PROD`, `OTBL`.`MNTH_KEY`, `OTBL`.`PARTY_RO_KEY`, `OTBL`.`INVC_LINE_QUANTITY`, `OTBL`.`vendor_spend_key`, `OTBL`.`OEM_KEY`, `OTBL`.`C1`, `OTBL`.`PARTY_GROUP_CODE`, `OTBL`.`PARTY_GROUP_NAME`, `OTBL`.`PARTY_GROUP_NAME_ALIAS`, `OTBL`.`EFF_START_DT`, `OTBL`.`EFF_END_DT`, `OTBL`.`CRN_ROW_IND`, `OTBL`.`party_name_hash`, `ITBL`.`VENDOR_KEY` AS `C2`, `ITBL`.`C1` AS `C3`, `ITBL`.`C2` AS `C4` FROM (SELECT `OTBL`.`PARTY_GROUP_KEY`, `OTBL`.`INVC_LINE_VALUE`, `OTBL`.`INVOICE_NUMBER`, `OTBL`.`INVC_ITEM_DESCRIPTION`, `OTBL`.`INVC_START_DT`, `OTBL`.`VENDOR_KEY`, `OTBL`.`VENDOR_GROUP_KEY`, `OTBL`.`PRD_KEY`, `OTBL`.`INVC_SLU_PROD`, `OTBL`.`MNTH_KEY`, `OTBL`.`PARTY_RO_KEY`, `OTBL`.`INVC_LINE_QUANTITY`, `OTBL`.`vendor_spend_key`, `OTBL`.`OEM_KEY`, `ITBL`.`PARTY_GROUP_KEY` AS `C1`, `ITBL`.`PARTY_GROUP_CODE`, `ITBL`.`PARTY_GROUP_NAME`, `ITBL`.`PARTY_GROUP_NAME_ALIAS`, `ITBL`.`EFF_START_DT`, `ITBL`.`EFF_END_DT`, `ITBL`.`CRN_ROW_IND`, `ITBL`.`party_name_hash` FROM `l4_aggr_db`.`fact_invoice_details_ref` AS `OTBL` INNER JOIN (SELECT `PARTY_GROUP_KEY`, `PARTY_GROUP_CODE`, `PARTY_GROUP_NAME`, `PARTY_GROUP_NAME_ALIAS`, `EFF_START_DT`, `EFF_END_DT`, `CRN_ROW_IND`, `party_name_hash` FROM `l3_dm_db`.`dim_party_group` WHERE `PARTY_GROUP_NAME_ALIAS` = 'Member4') AS `ITBL` ON `OTBL`.`PARTY_GROUP_KEY` = `ITBL`.`PARTY_GROUP_KEY`) AS `OTBL` INNER JOIN (SELECT `VENDOR_KEY`, `C1`, `C2` FROM (SELECT `VENDOR_KEY`, replace(`VENDOR_NAME_ALIAS`, 'DUKE', 'COMPUTER') AS `C1`, CASE WHEN (NOT (`IT_SUPPLIER_FLAG` IS NULL)) AND (`IT_SUPPLIER_FLAG` = 1) THEN 'IT Suppliers' ELSE 'Others' END AS `C2` FROM `l3_dm_db`.`dim_vendor`) AS `ITBL` WHERE `C2` = 'IT Suppliers') AS `ITBL` ON `OTBL`.`VENDOR_KEY` = `ITBL`.`VENDOR_KEY`) AS `OTBL` INNER JOIN (SELECT CASE WHEN (NOT (`segment_flag` IS NULL)) AND (`segment_flag` = 1) THEN 'OTHERS' ELSE CASE WHEN (NOT (`PRD_COMMODITY` IS NULL)) AND (`PRD_COMMODITY` = 'Others') THEN 'OTHERS' ELSE CASE WHEN (NOT (`PRD_COMMODITY` IS NULL)) AND (`PRD_COMMODITY` = 'Other') THEN 'OTHERS' ELSE CASE WHEN (`PRD_COMMODITY` IS NULL) OR (`PRD_COMMODITY` = '') THEN 'OTHERS' ELSE `PRD_COMMODITY` END END END END AS `C1`, `prd_key` FROM `l3_dm_db`.`dim_prd`) AS `ITBL` ON `OTBL`.`PRD_KEY` = `ITBL`.`prd_key`) AS `OTBL` INNER JOIN (SELECT `mnth_key`, `C2` FROM (SELECT `mnth_key`, CASE WHEN (NOT (`C1` IS NULL)) AND (`C1` = 1) THEN 'Last 12 Months' ELSE 'Previous Months' END AS `C2` FROM (SELECT `mnth_key`, CASE WHEN NOT (NOT (`mnth_key` IN ('202208', '202307', '202306', '202305', '202304', '202303', '202302', '202301', '202212', '202211', '202210', '202209'))) THEN 1 ELSE 0 END AS `C1` FROM `l3_dm_db`.`dim_month`) AS `ITBL`) AS `ITBL` WHERE `C2` = 'Last 12 Months') AS `ITBL` ON `OTBL`.`MNTH_KEY` = `ITBL`.`mnth_key`) AS `OTBL` INNER JOIN (SELECT `OEM_KEY`, `C1` FROM (SELECT `OEM_KEY`, CASE WHEN (NOT (`OEM_NAME` IS NULL)) AND (`OEM_NAME` = 'VALIDATION REQUIRED') THEN 'VALIDATION REQUIRED' ELSE CASE WHEN (NOT (`OEM_NAME` IS NULL)) AND (`OEM_NAME` = 'VALIDATION_REQUIRED') THEN 'VALIDATION REQUIRED' ELSE CASE WHEN (NOT (`OEM_NAME` IS NULL)) AND (`OEM_NAME` = 'unknown') THEN 'VALIDATION REQUIRED' ELSE 'OEM Identified' END END END AS `C1` FROM `l3_dm_db`.`dim_oem`) AS `ITBL` WHERE `C1` = 'OEM Identified') AS `ITBL` ON `OTBL`.`OEM_KEY` = `ITBL`.`OEM_KEY`) AS `ITBL` GROUP BY `C3`, `C5`, `INVOICE_NUMBER`, `INVC_ITEM_DESCRIPTION`, `INVC_START_DT`) AS `ITBL` WHERE NOT (`C1` IS NULL) LIMIT 1000001
